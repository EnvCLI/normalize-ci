# workflow
name: Release

# trigger
on:
  push:
    tags:        
      - v*

# jobs
jobs:
  # stages
  build:
    # runtime environment
    runs-on: ubuntu-latest

    # jobs
    steps:
    # checkout
    - uses: actions/checkout@v1
      with:
        fetch-depth: 1
    # prepare environment
    - name: Environment Setup
      run: |
        curl -L -s https://raw.githubusercontent.com/EnvCLI/modular-pipeline/master/install-prerequisites.sh | sudo bash -s
        curl -L -s https://raw.githubusercontent.com/EnvCLI/modular-pipeline/master/install.sh | sudo bash -s /usr/local
    # pipeline steps
    - name: Prepare
      run: |
        mpi stage prepare
    - name: Build
      env:
        UPX_ENABLE: "true"
        UPX_ARGS: --brute
      run: |
        mpi stage build
    - name: Test
      run: |
        mpi stage test
    - name: Package
      run: |
        mpi stage package
    - name: Publish
      env:
        BINTRAY_ORGANZATION: envcli
        BINTRAY_REPOSITORY: golang
        BINTRAY_PACKAGE: normalize-ci
        BINTRAY_USERNAME: philippheuer
        BINTRAY_TOKEN: ${{ secrets.BINTRAY_TOKEN }}
      run: |
        mpi stage publish
    - name: Audit
      run: |
        mpi stage audit
    - name: Performance
      run: |
        mpi stage performance
    - name: CleanUp
      run: |
        mpi stage cleanup
